podTemplate(label: 'acceptance',
  containers: [
    containerTemplate(name: 'maven-firefox', image: 'maven:3.6.3-jdk-11', ttyEnabled: true, command: 'cat'),
    containerTemplate(name: 'maven-chrome', image: 'maven:3.6.3-jdk-11', ttyEnabled: true, command: 'cat'),
    containerTemplate(name: 'selenium-hub', image: 'selenium/hub:4.0.0',
    ports:[ portMapping(name: 'hub1', containerPort: 4442, hostPort: 4442),
    portMapping(name: 'hub2', containerPort: 4443, hostPort: 4443),
    portMapping(name: 'hub3', containerPort: 4444, hostPort: 4444)
    ]),
    containerTemplate(name: 'selenium-chrome', image: 'selenium/node-chrome:4.0.0', envVars: [
      envVar(key: 'HUB_PORT_4444_TCP_ADDR', value: 'localhost'),
      envVar(key: 'HUB_PORT_4444_TCP_PORT', value: '4444'),
      envVar(key: 'DISPLAY', value: ':99.0'),
      envVar(key: 'SE_OPTS', value: '-port 5556'),   
      envVar(key: 'SE_EVENT_BUS_HOST', value: 'localhost'),
      envVar(key: 'SE_EVENT_BUS_PUBLISH_PORT', value: '4442'),
      envVar(key: 'SE_EVENT_BUS_SUBSCRIBE_PORT', value: '4443')
    ], ports:[ portMapping(name: 'chrome1', containerPort: 5900, hostPort: 6900)]
    ),
    containerTemplate(name: 'selenium-firefox', image: 'selenium/node-firefox:4.0.0', envVars: [
      envVar(key: 'HUB_PORT_4444_TCP_ADDR', value: 'localhost'),
      envVar(key: 'HUB_PORT_4444_TCP_PORT', value: '4444'),
      envVar(key: 'DISPLAY', value: ':98.0'),
      envVar(key: 'SE_OPTS', value: '-port 5557'),   
      envVar(key: 'SE_EVENT_BUS_HOST', value: 'localhost'),
      envVar(key: 'SE_EVENT_BUS_PUBLISH_PORT', value: '4442'),
      envVar(key: 'SE_EVENT_BUS_SUBSCRIBE_PORT', value: '4443')
    ], ports:[ portMapping(name: 'firefox1', containerPort: 5900, hostPort: 6901)]
    )
  ],
  volumes: [
    secretVolume(mountPath: '/etc/maven/', secretName: 'maven-settings-secret')
  ])
{
  node ('acceptance') {

    stage('Checkout the Notepad application') {
      git url: 'https://github.com/skyglass/notepad.git', branch: "${GIT_BRANCH}"
    }

    parallel (
      firefox: {
        stage('Run Acceptance Tests on Firefox') {
          container('maven-firefox') {
            sh """
              mvn -B -s /etc/maven/settings.xml clean verify -Pacceptance-tests -Dacceptance.notepad.url=${NOTEPAD_URL} -Dselenium.browser=firefox -Dsurefire.rerunFailingTestsCount=3
            """
          }
        }
      },
      chrome: {
        stage('Run Acceptance Tests on Chrome') {
          container('maven-chrome') {
            sh """
              mvn -B -s /etc/maven/settings.xml clean verify -Pacceptance-tests -Dacceptance.notepad.url=${NOTEPAD_URL} -Dselenium.browser=chrome -Dsurefire.rerunFailingTestsCount=3
            """
          }
        }
      }
    )
  }
}
